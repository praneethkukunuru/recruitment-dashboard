<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance & Recruiting Dashboard - TECHGENE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-left">
            <div class="menu-toggle" onclick="toggleSidebar()">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span>Menu</span>
            </div>
            <div class="logo-container">
                <img src="{{ url_for('static', filename='techgene-logo-new.png') }}" alt="TECHGENE" class="logo-image">
                <span class="dashboard-title" id="dashboard-title">Finance Dashboard</span>
            </div>
        </div>
        <div class="navbar-right">
            <div class="user-profile" id="user-profile">
                <div class="user-info">
                    <img id="user-avatar" src="" alt="User Avatar" class="user-avatar">
                    <span id="user-name" class="user-name">Loading...</span>
                </div>
                <div class="user-menu">
                    <button onclick="logout()" class="logout-btn">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sliding Sidebar Menu -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navigation</h3>
            <div class="close-btn" onclick="toggleSidebar()">&times;</div>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchDashboard('finance')">
                <span class="nav-icon">üìä</span>
                <span>Finance Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchDashboard('recruitment')">
                <span class="nav-icon">üë•</span>
                <span>Recruitment Dashboard</span>
            </div>
            
            <!-- Upload Sections -->
            <div class="nav-section-divider"></div>
            
            <div class="nav-section-title">Upload Data</div>
            
            <!-- Upload Finance Data -->
            <div class="nav-upload-section">
                <div class="nav-upload-title">üí∞ Finance Data</div>
                <div class="file-upload-nav" id="nav-finance-upload">
                    <div class="upload-area-nav">
                        <div class="upload-text-nav">Drop finance Excel file here</div>
                        <button class="browse-btn-nav">Choose File</button>
                    </div>
                    <input type="file" accept=".xlsx,.xls" style="display: none;" data-type="finance">
                </div>
            </div>
            
            <!-- Upload Recruitment Data -->
            <div class="nav-upload-section">
                <div class="nav-upload-title">üìä Recruitment Data</div>
                <div class="file-upload-nav" id="nav-rec-upload">
                    <div class="upload-area-nav">
                        <div class="upload-text-nav">Drop recruitment Excel file here</div>
                        <button class="browse-btn-nav">Choose File</button>
                    </div>
                    <input type="file" accept=".xlsx,.xls" style="display: none;" data-type="rec">
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Data Management Sidebar -->
        <div class="data-sidebar" id="data-sidebar">
            <div class="sidebar-header">
                <h3>Data Management</h3>
            </div>
            
            <div class="sidebar-content">
                <!-- Add Monthly Data Section -->
                <div class="sidebar-section">
                    <h4>Add Monthly Data</h4>
                    <form id="monthly-data-form">
                        <div class="form-group">
                            <label>Month</label>
                            <select id="new-month" class="form-select">
                                <option value="">Select Month</option>
                                <option value="Sep">September</option>
                                <option value="Oct">October</option>
                                <option value="Nov">November</option>
                                <option value="Dec">December</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>TG W2</label>
                            <input type="number" id="tg-w2" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>TG C2C</label>
                            <input type="number" id="tg-c2c" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>TG 1099</label>
                            <input type="number" id="tg-1099" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>TG Referral</label>
                            <input type="number" id="tg-referral" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>VNST W2</label>
                            <input type="number" id="vnst-w2" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>VNST SC</label>
                            <input type="number" id="vnst-sc" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>New Placements</label>
                            <input type="number" id="new-placements" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>Terminations</label>
                            <input type="number" id="terminations" class="form-input" placeholder="0">
                        </div>
                        
                        <button type="submit" class="add-data-btn">Add Month Data</button>
                    </form>
                </div>
                
                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <h4>Quick Actions</h4>
                    <button class="action-btn" onclick="exportCurrentData()">Export Current Data</button>
                    <button class="action-btn" onclick="resetDashboard()">Reset Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Finance Dashboard -->
            <div class="dashboard-view" id="finance-dashboard">
            <!-- Full Screen Upload Zone (Initial State) -->
            <div class="fullscreen-upload-zone" id="finance-upload-section">
                <div class="upload-container">
                    <div class="upload-content">
                        <div class="upload-icon-large">üí∞</div>
                        <h2>Finance Dashboard</h2>
                        <p>Upload your Monthly Income & Expenses Excel file to get started</p>
                        <div class="file-upload" id="finance-upload">
                            <div class="upload-area">
                                <div class="upload-icon">üí∞</div>
                                <div class="upload-text">Drop your Monthly Income & Expenses Excel file here</div>
                                <div class="upload-limit">Excel files (.xlsx, .xls) ‚Ä¢ Max 200MB</div>
                                <button class="browse-btn">Choose File</button>
                            </div>
                            <input type="file" accept=".xlsx,.xls" style="display: none;" data-type="finance">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finance KPIs Section -->
            <div class="section">
                <div class="section-title-with-download">
                    <span class="section-title">Financial Summary</span>
                    <button class="download-icon-btn" id="download-finance-report" title="Download Finance Report">
                        <span class="download-icon">‚¨áÔ∏è</span>
                    </button>
                </div>
                <div class="kpi-grid">
                    <!-- Direct Hire Section -->
                    <div class="business-unit-section">
                        <h3 class="business-unit-title">Direct Hire</h3>
                        <div class="kpi-card" data-kpi="direct_hire_total_revenue">
                            <div class="kpi-label">Total Revenue</div>
                            <div class="kpi-value" id="kpi-direct-hire-total-revenue">‚Äî</div>
                        </div>
                        <div class="kpi-card" data-kpi="direct_hire_gross_income">
                            <div class="kpi-label">Gross Income</div>
                            <div class="kpi-value" id="kpi-direct-hire-gross-income">‚Äî</div>
                        </div>
                        <div class="kpi-card" data-kpi="direct_hire_net_income">
                            <div class="kpi-label">Net Income</div>
                            <div class="kpi-value" id="kpi-direct-hire-net-income">‚Äî</div>
                        </div>
                    </div>
                    
                    <!-- IT Services Section -->
                    <div class="business-unit-section">
                        <h3 class="business-unit-title">IT Services</h3>
                        <div class="kpi-card" data-kpi="it_services_total_revenue">
                            <div class="kpi-label">Total Revenue</div>
                            <div class="kpi-value" id="kpi-it-services-total-revenue">‚Äî</div>
                        </div>
                        <div class="kpi-card" data-kpi="it_services_gross_income">
                            <div class="kpi-label">Gross Income</div>
                            <div class="kpi-value" id="kpi-it-services-gross-income">‚Äî</div>
                        </div>
                        <div class="kpi-card" data-kpi="it_services_net_income">
                            <div class="kpi-label">Net Income</div>
                            <div class="kpi-value" id="kpi-it-services-net-income">‚Äî</div>
                        </div>
                    </div>
                    
                    <!-- IT Staffing Section -->
                    <div class="business-unit-section">
                        <h3 class="business-unit-title">IT Staffing</h3>
                        <div class="kpi-card" data-kpi="it_staffing_total_revenue">
                            <div class="kpi-label">Total Revenue</div>
                            <div class="kpi-value" id="kpi-it-staffing-total-revenue">‚Äî</div>
                        </div>
                        <div class="kpi-card" data-kpi="it_staffing_gross_income">
                            <div class="kpi-label">Gross Income</div>
                            <div class="kpi-value" id="kpi-it-staffing-gross-income">‚Äî</div>
                        </div>
                        <div class="kpi-card" data-kpi="it_staffing_net_income">
                            <div class="kpi-label">Net Income</div>
                            <div class="kpi-value" id="kpi-it-staffing-net-income">‚Äî</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formula Editor Modal (Hidden by default) -->
            <div id="formula-editor-modal" class="formula-modal" style="display: none;">
                <div class="formula-modal-content">
                    <div class="formula-modal-header">
                        <h3 id="formula-editor-title">Edit Formula</h3>
                        <button class="close-btn" onclick="closeFormulaEditor()">&times;</button>
                    </div>
                    
                    <div class="formula-editor-body">
                        <!-- Available Variables -->
                        <div class="variables-section">
                            <h4>Available Variables</h4>
                            <div class="variables-grid" id="variables-grid">
                                <!-- Variables will be populated dynamically -->
                            </div>
                        </div>
                        
                        <!-- Formula Builder -->
                        <div class="formula-builder-section">
                            <h4>Formula Builder</h4>
                            
                            <!-- Operator Buttons -->
                            <div class="operator-buttons">
                                <button class="operator-btn" onclick="addOperator('+')">+</button>
                                <button class="operator-btn" onclick="addOperator('-')">-</button>
                                <button class="operator-btn" onclick="addOperator('*')">√ó</button>
                                <button class="operator-btn" onclick="addOperator('/')">√∑</button>
                                <button class="operator-btn" onclick="addOperator('(')">(</button>
                                <button class="operator-btn" onclick="addOperator(')')">)</button>
                                <button class="operator-btn delete-btn" onclick="deleteLastItem()">‚å´</button>
                                <button class="operator-btn clear-btn" onclick="clearFormula()">Clear</button>
                            </div>
                            
                            <div class="formula-canvas" id="formula-canvas">
                                <div class="formula-placeholder">Drag variables here to build your formula</div>
                            </div>
                            
                            <!-- Formula Preview -->
                            <div class="formula-preview-section">
                                <label>Formula Preview:</label>
                                <div class="formula-preview" id="formula-preview">= </div>
                            </div>
                            
                            <!-- Formula Result -->
                            <div class="formula-result-section">
                                <label>Result:</label>
                                <div class="formula-result" id="formula-result">$0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="formula-modal-footer">
                        <button class="btn btn-secondary" onclick="resetFormula()">Reset to Default</button>
                        <button class="btn btn-primary" onclick="saveFormula()">Save Formula</button>
                    </div>
                </div>
            </div>

            <!-- Visuals Section -->
            <div class="section">
                <div class="section-title">Financial Analytics</div>
                <div id="finance-charts-container">
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>Direct Hire Revenue, Direct Hire Gross Income, Direct Hire Net Income</h4>
                            <div id="chart-direct-hire-finance"></div>
                        </div>
                        <div class="chart-container">
                            <h4>Services Revenue, Services Gross Income, Services Net Income</h4>
                            <div id="chart-services-finance"></div>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>IT Staffing Revenue, IT Staffing Gross Income, IT Staffing Net Income</h4>
                            <div id="chart-it-staffing-finance"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Recruitment Dashboard -->
        <div class="dashboard-view" id="recruitment-dashboard" style="display: none;">
            <!-- Full Screen Upload Zone (Initial State) -->
            <div class="fullscreen-upload-zone" id="initial-upload-section">
                <div class="upload-container">
                    <div class="upload-content">
                        <div class="upload-icon-large">üìä</div>
                        <h1 class="upload-title">Upload Placement Report</h1>
                        <p class="upload-subtitle">Drop your Excel file anywhere on this screen</p>
                        <div class="upload-zone" id="rec-upload">
                            <div class="upload-area-fullscreen">
                                <div class="upload-icon">üìä</div>
                                <div class="upload-text">Drop your placement report Excel file here</div>
                                <div class="upload-limit">Excel files (.xlsx, .xls) ‚Ä¢ Max 200MB</div>
                                <div class="upload-description">
                                    <strong>Expected sheets:</strong><br>
                                    ‚Ä¢ Sheet 1: Employment Types (W2, C2C, 1099, Referral)<br>
                                    ‚Ä¢ Sheet 2: Placement Metrics (New Placements, Terminations, Net)<br>
                                    ‚Ä¢ Sheet 3: Gross Margin Data (2024/2025)<br>
                                    ‚Ä¢ Sheet 4: Additional Charts/Data
                                </div>
                                <button class="browse-btn-large">Choose File</button>
                                <div class="upload-status" id="rec-upload-status"></div>
                            </div>
                            <input type="file" accept=".xlsx,.xls" style="display: none;" data-type="rec">
                        </div>
                    </div>
                </div>
            </div>


            <div id="no-rec-data-message" class="info-message">
                Upload your placement report Excel file above to start analyzing employment types, placement metrics, and gross margins.
            </div>

            <!-- Recruitment KPIs Section -->
            <div class="section">
                <div class="section-title-with-download">
                    <span class="section-title">Placement Report Summary</span>
                    <button class="download-icon-btn" id="download-recruitment-report" title="Download Recruitment Report">
                        <span class="download-icon">‚¨áÔ∏è</span>
                    </button>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card" data-kpi="total_placements">
                        <div class="kpi-label">Total Placements</div>
                        <div class="kpi-value" id="kpi-total-placements">‚Äî</div>
                    </div>
                    <div class="kpi-card" data-kpi="total_terminations">
                        <div class="kpi-label">Total Terminations</div>
                        <div class="kpi-value" id="kpi-total-terminations">‚Äî</div>
                    </div>
                    <div class="kpi-card" data-kpi="net_placements">
                        <div class="kpi-label">Net Placements</div>
                        <div class="kpi-value" id="kpi-net-placements">‚Äî</div>
                    </div>
                    <div class="kpi-card" data-kpi="net_billables">
                        <div class="kpi-label">Net Billables</div>
                        <div class="kpi-value" id="kpi-net-billables">‚Äî</div>
                    </div>
                </div>
            </div>

            <!-- Visuals Section -->
            <div class="section">
                <div class="section-title">Recruitment Analytics</div>
                <div id="recruitment-charts-container">
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>Placement Metrics</h4>
                            <div id="chart-placement-metrics"></div>
                        </div>
                        <div class="chart-container">
                            <h4>Gross Margin Analysis</h4>
                            <div id="chart-gross-margin"></div>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>Billables Trend</h4>
                            <div id="chart-billables-trend"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        </div>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        let currentDashboard = 'finance';
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }
        
        function switchDashboard(dashboardType) {
            // Scroll to top when switching dashboards
            if (typeof scrollToTop === 'function') {
                scrollToTop();
            } else {
                window.scrollTo(0, 0);
            }
            
            // Hide current dashboard
            document.querySelectorAll('.dashboard-view').forEach(view => {
                view.style.display = 'none';
            });
            
            // Show selected dashboard
            document.getElementById(dashboardType + '-dashboard').style.display = 'block';
            
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the correct nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if ((dashboardType === 'finance' && text.includes('finance')) ||
                    (dashboardType === 'recruitment' && text.includes('recruitment')) ||
                    (dashboardType === 'data-explorer' && text.includes('data explorer'))) {
                    item.classList.add('active');
                }
            });
            
            // Update title
            const titles = {
                'finance': 'Finance Dashboard',
                'recruitment': 'Recruitment Dashboard',
                'data-explorer': 'Data Explorer'
            };
            document.getElementById('dashboard-title').textContent = titles[dashboardType];
            
            currentDashboard = dashboardType;
            window.currentDashboard = dashboardType;
            
            // Check for existing data and show appropriate UI
            checkAndShowDashboardUI(dashboardType);
            
            // Close navigation sidebar after switching
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }
        
        function checkAndShowDashboardUI(dashboardType) {
            // Check for existing data via AJAX
            $.ajax({
                url: '/check_existing_data',
                method: 'GET',
                success: function(response) {
                    console.log('Dashboard switch - data check response:', response);
                    
                    const dataSidebar = document.getElementById('data-sidebar');
                    const mainContent = document.querySelector('.main-content');
                    
                    if (dashboardType === 'recruitment') {
                        const hasData = response.has_recruitment_data || false;
                        console.log('Recruitment dashboard has data:', hasData);
                        
                        if (hasData) {
                            // Show sidebar for recruitment dashboard with data
                            dataSidebar.style.display = 'block';
                            mainContent.classList.remove('finance-mode');
                            mainContent.classList.add('recruitment-mode');
                            // Hide upload screen and show dashboard sections
                            $('#initial-upload-section').hide();
                            $('.section').show();
                        } else {
                            // Hide sidebar when no data (full screen upload mode)
                            dataSidebar.style.display = 'none';
                            mainContent.classList.remove('finance-mode', 'recruitment-mode');
                            // Show upload screen and hide dashboard sections
                            $('#initial-upload-section').show();
                            $('.section').hide();
                        }
                    } else if (dashboardType === 'finance') {
                        const hasData = response.has_finance_data || false;
                        console.log('Finance dashboard has data:', hasData);
                        
                        if (hasData) {
                            // Hide sidebar for finance dashboard with data
                            dataSidebar.style.display = 'none';
                            mainContent.classList.remove('recruitment-mode');
                            mainContent.classList.add('finance-mode');
                            // Hide upload screen and show dashboard sections
                            $('#finance-upload-section').hide();
                            $('.section').show();
                        } else {
                            // Hide sidebar when no data (full screen upload mode)
                            dataSidebar.style.display = 'none';
                            mainContent.classList.remove('finance-mode', 'recruitment-mode');
                            // Show upload screen and hide dashboard sections
                            $('#finance-upload-section').show();
                            $('.section').hide();
                        }
                    } else if (dashboardType === 'data-explorer') {
                        // Hide sidebar for data explorer
                        dataSidebar.style.display = 'none';
                        mainContent.classList.remove('finance-mode', 'recruitment-mode');
                        
                        // Load data explorer data when switching to it
                        if (typeof loadDataExplorerData === 'function') {
                            loadDataExplorerData();
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error checking existing data during dashboard switch:', error);
                    // Default to showing upload screens on error
                    if (dashboardType === 'recruitment') {
                        $('#initial-upload-section').show();
                        $('.section').hide();
                    } else if (dashboardType === 'finance') {
                        $('#finance-upload-section').show();
                        $('.section').hide();
                    }
                }
            });
        }
        
        function showReports() {
            alert('Reports functionality coming soon!');
            toggleSidebar();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Scroll to top on page load
            if (typeof scrollToTop === 'function') {
                scrollToTop();
            } else {
                window.scrollTo(0, 0);
            }
            
            // Show finance dashboard by default
            document.getElementById('finance-dashboard').style.display = 'block';
            document.getElementById('recruitment-dashboard').style.display = 'none';
            
            // Set finance nav item as active
            document.querySelectorAll('.nav-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes('finance')) {
                    item.classList.add('active');
                }
            });
            
            // Initialize main content classes
            const mainContent = document.querySelector('.main-content');
            const dataSidebar = document.getElementById('data-sidebar');
            
            currentDashboard = 'finance';
            window.currentDashboard = 'finance';
            dataSidebar.style.display = 'none';
            mainContent.classList.add('finance-mode');
            
            // Check for existing data in session
            if (typeof checkForExistingData === 'function') {
                checkForExistingData();
            }
        });
      </script>
  </body>
</html>