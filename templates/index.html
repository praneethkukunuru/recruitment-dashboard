<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance & Recruiting Dashboard - TECHGENE</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-left">
            <div class="menu-toggle" onclick="toggleSidebar()">
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span>Menu</span>
            </div>
            <div class="logo-container">
                <img src="{{ url_for('static', filename='techgene-logo-new.png') }}" alt="TECHGENE" class="logo-image">
                <span class="dashboard-title" id="dashboard-title">Finance Dashboard</span>
            </div>
        </div>
    </nav>

    <!-- Sliding Sidebar Menu -->
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Navigation</h3>
            <div class="close-btn" onclick="toggleSidebar()">&times;</div>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchDashboard('finance')">
                <span class="nav-icon">üìä</span>
                <span>Finance Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchDashboard('recruitment')">
                <span class="nav-icon">üë•</span>
                <span>Recruitment Dashboard</span>
            </div>
            <div class="nav-item" onclick="switchDashboard('data-explorer')">
                <span class="nav-icon">üîç</span>
                <span>Data Explorer</span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Data Management Sidebar -->
        <div class="data-sidebar" id="data-sidebar">
            <div class="sidebar-header">
                <h3>Data Management</h3>
            </div>
            
            <div class="sidebar-content">
                <!-- Upload New Data Section -->
                <div class="sidebar-section">
                    <h4>Upload New Report</h4>
                    <div class="file-upload-sidebar" id="sidebar-rec-upload">
                        <div class="upload-area-sidebar">
                            <div class="upload-icon">üìä</div>
                            <div class="upload-text">Drop new Excel file here</div>
                            <div class="upload-limit">Excel files (.xlsx, .xls)</div>
                            <button class="browse-btn-small">Choose File</button>
                        </div>
                        <input type="file" accept=".xlsx,.xls" style="display: none;" data-type="rec">
                    </div>
                </div>
                
                <!-- Upload Finance Data Section -->
                <div class="sidebar-section">
                    <h4>Upload Finance Data</h4>
                    <div class="file-upload-sidebar" id="sidebar-finance-upload">
                        <div class="upload-area-sidebar">
                            <div class="upload-icon">üí∞</div>
                            <div class="upload-text">Drop finance Excel file here</div>
                            <div class="upload-limit">Excel files (.xlsx, .xls)</div>
                            <button class="browse-btn-small">Choose File</button>
                        </div>
                        <input type="file" accept=".xlsx,.xls" style="display: none;" data-type="finance">
                    </div>
                </div>
                
                <!-- Add Monthly Data Section -->
                <div class="sidebar-section">
                    <h4>Add Monthly Data</h4>
                    <form id="monthly-data-form">
                        <div class="form-group">
                            <label>Month</label>
                            <select id="new-month" class="form-select">
                                <option value="">Select Month</option>
                                <option value="Sep">September</option>
                                <option value="Oct">October</option>
                                <option value="Nov">November</option>
                                <option value="Dec">December</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>TG W2</label>
                            <input type="number" id="tg-w2" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>TG C2C</label>
                            <input type="number" id="tg-c2c" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>TG 1099</label>
                            <input type="number" id="tg-1099" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>TG Referral</label>
                            <input type="number" id="tg-referral" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>VNST W2</label>
                            <input type="number" id="vnst-w2" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>VNST SC</label>
                            <input type="number" id="vnst-sc" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>New Placements</label>
                            <input type="number" id="new-placements" class="form-input" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label>Terminations</label>
                            <input type="number" id="terminations" class="form-input" placeholder="0">
                        </div>
                        
                        <button type="submit" class="add-data-btn">Add Month Data</button>
                    </form>
                </div>
                
                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <h4>Quick Actions</h4>
                    <button class="action-btn" onclick="exportCurrentData()">Export Current Data</button>
                    <button class="action-btn" onclick="resetDashboard()">Reset Dashboard</button>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Finance Dashboard -->
            <div class="dashboard-view" id="finance-dashboard">
            <!-- Full Screen Upload Zone (Initial State) -->
            <div class="fullscreen-upload-zone" id="finance-upload-section">
                <div class="upload-container">
                    <div class="upload-content">
                        <div class="upload-icon-large">üí∞</div>
                        <h2>Finance Dashboard</h2>
                        <p>Upload your Monthly Income & Expenses Excel file to get started</p>
                        <div class="file-upload" id="finance-upload">
                            <div class="upload-area">
                                <div class="upload-icon">üí∞</div>
                                <div class="upload-text">Drop your Monthly Income & Expenses Excel file here</div>
                                <div class="upload-limit">Excel files (.xlsx, .xls) ‚Ä¢ Max 200MB</div>
                                <button class="browse-btn">Choose File</button>
                            </div>
                            <input type="file" accept=".xlsx,.xls" style="display: none;" data-type="finance">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finance KPIs Section -->
            <div class="section">
                <div class="section-title-with-download">
                    <span class="section-title">Financial Summary</span>
                    <button class="download-icon-btn" id="download-finance-report" title="Download Finance Report">
                        <span class="download-icon">‚¨áÔ∏è</span>
                    </button>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card" data-kpi="total_revenue">
                        <div class="kpi-label">Total Revenue (YTD)</div>
                        <div class="kpi-value" id="kpi-total-revenue">‚Äî</div>
                    </div>
                    <div class="kpi-card" data-kpi="total_expenses">
                        <div class="kpi-label">Total Expenses (YTD)</div>
                        <div class="kpi-value" id="kpi-total-expenses">‚Äî</div>
                    </div>
                    <div class="kpi-card" data-kpi="total_net_income">
                        <div class="kpi-label">Net Income (YTD)</div>
                        <div class="kpi-value" id="kpi-net-income">‚Äî</div>
                    </div>
                    <div class="kpi-card" data-kpi="profit_margin">
                        <div class="kpi-label">Profit Margin</div>
                        <div class="kpi-value" id="kpi-profit-margin">‚Äî</div>
                    </div>
                    <div class="kpi-card" data-kpi="avg_monthly_revenue">
                        <div class="kpi-label">Avg Monthly Revenue</div>
                        <div class="kpi-value" id="kpi-avg-monthly-revenue">‚Äî</div>
                    </div>
                    <div class="kpi-card" data-kpi="avg_monthly_net_income">
                        <div class="kpi-label">Avg Monthly Net Income</div>
                        <div class="kpi-value" id="kpi-avg-monthly-net-income">‚Äî</div>
                    </div>
                </div>
            </div>

            <!-- Formula Editor Modal (Hidden by default) -->
            <div id="formula-editor-modal" class="formula-modal" style="display: none;">
                <div class="formula-modal-content">
                    <div class="formula-modal-header">
                        <h3 id="formula-editor-title">Edit Formula</h3>
                        <button class="close-btn" onclick="closeFormulaEditor()">&times;</button>
                    </div>
                    
                    <div class="formula-editor-body">
                        <!-- Available Variables -->
                        <div class="variables-section">
                            <h4>Available Variables</h4>
                            <div class="variables-grid" id="variables-grid">
                                <!-- Variables will be populated dynamically -->
                            </div>
                        </div>
                        
                        <!-- Formula Builder -->
                        <div class="formula-builder-section">
                            <h4>Formula Builder</h4>
                            
                            <!-- Operator Buttons -->
                            <div class="operator-buttons">
                                <button class="operator-btn" onclick="addOperator('+')">+</button>
                                <button class="operator-btn" onclick="addOperator('-')">-</button>
                                <button class="operator-btn" onclick="addOperator('*')">√ó</button>
                                <button class="operator-btn" onclick="addOperator('/')">√∑</button>
                                <button class="operator-btn" onclick="addOperator('(')">(</button>
                                <button class="operator-btn" onclick="addOperator(')')">)</button>
                                <button class="operator-btn delete-btn" onclick="deleteLastItem()">‚å´</button>
                                <button class="operator-btn clear-btn" onclick="clearFormula()">Clear</button>
                            </div>
                            
                            <div class="formula-canvas" id="formula-canvas">
                                <div class="formula-placeholder">Drag variables here to build your formula</div>
                            </div>
                            
                            <!-- Formula Preview -->
                            <div class="formula-preview-section">
                                <label>Formula Preview:</label>
                                <div class="formula-preview" id="formula-preview">= </div>
                            </div>
                            
                            <!-- Formula Result -->
                            <div class="formula-result-section">
                                <label>Result:</label>
                                <div class="formula-result" id="formula-result">$0</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="formula-modal-footer">
                        <button class="btn btn-secondary" onclick="resetFormula()">Reset to Default</button>
                        <button class="btn btn-primary" onclick="saveFormula()">Save Formula</button>
                    </div>
                </div>
            </div>

            <!-- Visuals Section -->
            <div class="section">
                <div class="section-title">Financial Analytics</div>
                <div id="finance-charts-container">
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>Direct Hire Revenue, Direct Hire Gross Income, Direct Hire Net Income</h4>
                            <div id="chart-direct-hire-finance"></div>
                        </div>
                        <div class="chart-container">
                            <h4>Services Revenue, Services Gross Income, Services Net Income</h4>
                            <div id="chart-services-finance"></div>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>IT Staffing Revenue, IT Staffing Gross Income, IT Staffing Net Income</h4>
                            <div id="chart-it-staffing-finance"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Recruitment Dashboard -->
        <div class="dashboard-view" id="recruitment-dashboard" style="display: none;">
            <!-- Full Screen Upload Zone (Initial State) -->
            <div class="fullscreen-upload-zone" id="initial-upload-section">
                <div class="upload-container">
                    <div class="upload-content">
                        <div class="upload-icon-large">üìä</div>
                        <h1 class="upload-title">Upload Placement Report</h1>
                        <p class="upload-subtitle">Drop your Excel file anywhere on this screen</p>
                        <div class="upload-zone" id="rec-upload">
                            <div class="upload-area-fullscreen">
                                <div class="upload-icon">üìä</div>
                                <div class="upload-text">Drop your placement report Excel file here</div>
                                <div class="upload-limit">Excel files (.xlsx, .xls) ‚Ä¢ Max 200MB</div>
                                <div class="upload-description">
                                    <strong>Expected sheets:</strong><br>
                                    ‚Ä¢ Sheet 1: Employment Types (W2, C2C, 1099, Referral)<br>
                                    ‚Ä¢ Sheet 2: Placement Metrics (New Placements, Terminations, Net)<br>
                                    ‚Ä¢ Sheet 3: Gross Margin Data (2024/2025)<br>
                                    ‚Ä¢ Sheet 4: Additional Charts/Data
                                </div>
                                <button class="browse-btn-large">Choose File</button>
                                <div class="upload-status" id="rec-upload-status"></div>
                            </div>
                            <input type="file" accept=".xlsx,.xls" style="display: none;" data-type="rec">
                        </div>
                    </div>
                </div>
            </div>


            <div id="no-rec-data-message" class="info-message">
                Upload your placement report Excel file above to start analyzing employment types, placement metrics, and gross margins.
            </div>

            <!-- Recruitment KPIs Section -->
            <div class="section">
                <div class="section-title-with-download">
                    <span class="section-title">Placement Report Summary</span>
                    <button class="download-icon-btn" id="download-recruitment-report" title="Download Recruitment Report">
                        <span class="download-icon">‚¨áÔ∏è</span>
                    </button>
                </div>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Total Current Billables</div>
                        <div class="kpi-value" id="kpi-total-billables">‚Äî</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">W2 Placements</div>
                        <div class="kpi-value" id="kpi-w2-count">‚Äî</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Net Placements (Latest Month)</div>
                        <div class="kpi-value" id="kpi-net-placements">‚Äî</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Gross Margin Total</div>
                        <div class="kpi-value" id="kpi-gross-margin">‚Äî</div>
                    </div>
                </div>
            </div>

            <!-- Recruitment Visuals Section -->
            <div class="section">
                <div class="section-title">Placement Report Analytics</div>
                <div id="recruitment-charts-container">
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>Employment Types Trend (W2, C2C, 1099, Referral)</h4>
                            <div id="chart-employment-types"></div>
                        </div>
                        <div class="chart-container">
                            <h4>Placement Metrics (New, Terminations, Net)</h4>
                            <div id="chart-placement-metrics"></div>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-container">
                            <h4>Monthly Billables Trend</h4>
                            <div id="chart-billables-trend"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Data Explorer Dashboard -->
        <div class="dashboard-view" id="data-explorer-dashboard">
            <!-- Data Explorer Header -->
            <div class="section">
                <div class="section-title">Data Explorer</div>
                <div class="data-explorer-info">
                    <p>View and explore the raw data from your uploaded files. This provides complete transparency into the data used for calculations.</p>
                </div>
            </div>

            <!-- Data Source Selection -->
            <div class="section">
                <div class="section-title">Data Sources</div>
                <div class="data-source-tabs">
                    <button class="data-tab-btn active" onclick="switchDataSource('recruitment')" id="tab-recruitment">
                        <span class="tab-icon">üë•</span>
                        <span class="tab-text">Recruitment Data</span>
                        <span class="tab-status" id="status-recruitment">No Data</span>
                    </button>
                    <button class="data-tab-btn" onclick="switchDataSource('finance')" id="tab-finance">
                        <span class="tab-icon">üí∞</span>
                        <span class="tab-text">Finance Data</span>
                        <span class="tab-status" id="status-finance">No Data</span>
                    </button>
                </div>
            </div>

            <!-- Recruitment Data Explorer -->
            <div class="data-source-content" id="content-recruitment">
                <div class="section">
                    <div class="section-title">Recruitment Data Tables</div>
                    <div class="data-table-controls">
                        <div class="search-controls">
                            <input type="text" id="recruitment-search" placeholder="Search in recruitment data..." class="search-input">
                            <button class="btn btn-secondary" onclick="clearRecruitmentSearch()">Clear</button>
                        </div>
                        <div class="export-controls">
                            <button class="btn btn-primary" onclick="exportRecruitmentData()">
                                <span class="btn-icon">üì•</span>
                                Export Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="data-tables">
                        <div class="data-table-section">
                            <h4>Employment Types Data</h4>
                            <div class="table-container">
                                <table class="data-table" id="recruitment-employment-table">
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>TG W2</th>
                                            <th>TG C2C</th>
                                            <th>TG 1099</th>
                                            <th>TG Referral</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="data-table-section">
                            <h4>Placement Metrics Data</h4>
                            <div class="table-container">
                                <table class="data-table" id="recruitment-placements-table">
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>New Placements</th>
                                            <th>Terminations</th>
                                            <th>Net Placements</th>
                                            <th>Total Billables</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Finance Data Explorer -->
            <div class="data-source-content" id="content-finance" style="display: none;">
                <div class="section">
                    <div class="section-title">Finance Data Tables</div>
                    <div class="data-table-controls">
                        <div class="search-controls">
                            <input type="text" id="finance-search" placeholder="Search in finance data..." class="search-input">
                            <button class="btn btn-secondary" onclick="clearFinanceSearch()">Clear</button>
                        </div>
                        <div class="export-controls">
                            <button class="btn btn-primary" onclick="exportFinanceData()">
                                <span class="btn-icon">üì•</span>
                                Export Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="data-tables">
                        <div class="data-table-section">
                            <h4>Business Units Summary</h4>
                            <div class="table-container">
                                <table class="data-table" id="finance-summary-table">
                                    <thead>
                                        <tr>
                                            <th>Business Unit</th>
                                            <th>Jan</th>
                                            <th>Feb</th>
                                            <th>Mar</th>
                                            <th>Apr</th>
                                            <th>May</th>
                                            <th>Jun</th>
                                            <th>Jul</th>
                                            <th>Aug</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="data-table-section">
                            <h4>Monthly P&L Data</h4>
                            <div class="table-container">
                                <table class="data-table" id="finance-pnl-table">
                                    <thead>
                                        <tr>
                                            <th>Company</th>
                                            <th>Month</th>
                                            <th>Total Income</th>
                                            <th>Total Expenses</th>
                                            <th>Net Income</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Data will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script>
        let currentDashboard = 'finance';
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }
        
        function switchDashboard(dashboardType) {
            // Scroll to top when switching dashboards
            if (typeof scrollToTop === 'function') {
                scrollToTop();
            } else {
                window.scrollTo(0, 0);
            }
            
            // Hide current dashboard
            document.querySelectorAll('.dashboard-view').forEach(view => {
                view.style.display = 'none';
            });
            
            // Show selected dashboard
            document.getElementById(dashboardType + '-dashboard').style.display = 'block';
            
            // Update navigation active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the correct nav item
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if ((dashboardType === 'finance' && text.includes('finance')) ||
                    (dashboardType === 'recruitment' && text.includes('recruitment')) ||
                    (dashboardType === 'data-explorer' && text.includes('data explorer'))) {
                    item.classList.add('active');
                }
            });
            
            // Update title
            const titles = {
                'finance': 'Finance Dashboard',
                'recruitment': 'Recruitment Dashboard',
                'data-explorer': 'Data Explorer'
            };
            document.getElementById('dashboard-title').textContent = titles[dashboardType];
            
            currentDashboard = dashboardType;
            window.currentDashboard = dashboardType;
            
            // Show/hide data sidebar based on dashboard type
            const dataSidebar = document.getElementById('data-sidebar');
            const mainContent = document.querySelector('.main-content');
            
            if (dashboardType === 'recruitment') {
                // Check if recruitment dashboard has data
                const hasData = $('#initial-upload-section').is(':hidden') && $('.section').is(':visible');
                if (hasData) {
                    // Show sidebar for recruitment dashboard with data
                    dataSidebar.style.display = 'block';
                    mainContent.classList.remove('finance-mode');
                    mainContent.classList.add('recruitment-mode');
                } else {
                    // Hide sidebar when no data (full screen upload mode)
                    dataSidebar.style.display = 'none';
                    mainContent.classList.remove('finance-mode', 'recruitment-mode');
                }
            } else if (dashboardType === 'finance') {
                // Check if finance dashboard has data
                const hasData = $('#finance-upload-section').is(':hidden') && $('.section').is(':visible');
                if (hasData) {
                    // Hide sidebar for finance dashboard with data
                    dataSidebar.style.display = 'none';
                    mainContent.classList.remove('recruitment-mode');
                    mainContent.classList.add('finance-mode');
                } else {
                    // Hide sidebar when no data (full screen upload mode)
                    dataSidebar.style.display = 'none';
                    mainContent.classList.remove('finance-mode', 'recruitment-mode');
                }
            } else if (dashboardType === 'data-explorer') {
                // Hide sidebar for data explorer
                dataSidebar.style.display = 'none';
                mainContent.classList.remove('finance-mode', 'recruitment-mode');
                
                // Load data explorer data when switching to it
                if (typeof loadDataExplorerData === 'function') {
                    loadDataExplorerData();
                }
            }
            
            // Restore UI for dashboard with existing data
            if (dashboardType === 'recruitment' && window.recruitmentData) {
                // Hide upload screen and show dashboard sections
                $('#initial-upload-section').hide();
                $('.section').show();
            } else if (dashboardType === 'finance' && window.financeData) {
                // Hide upload screen and show dashboard sections
                $('#finance-upload-section').hide();
                $('.section').show();
            }
            
            // Close navigation sidebar after switching
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }
        
        function showReports() {
            alert('Reports functionality coming soon!');
            toggleSidebar();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Scroll to top on page load
            if (typeof scrollToTop === 'function') {
                scrollToTop();
            } else {
                window.scrollTo(0, 0);
            }
            
            // Show finance dashboard by default
            document.getElementById('finance-dashboard').style.display = 'block';
            document.getElementById('recruitment-dashboard').style.display = 'none';
            
            // Set finance nav item as active
            document.querySelectorAll('.nav-item').forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes('finance')) {
                    item.classList.add('active');
                }
            });
            
            // Initialize main content classes
            const mainContent = document.querySelector('.main-content');
            const dataSidebar = document.getElementById('data-sidebar');
            
            currentDashboard = 'finance';
            window.currentDashboard = 'finance';
            dataSidebar.style.display = 'none';
            mainContent.classList.add('finance-mode');
        });
      </script>
  </body>
</html>